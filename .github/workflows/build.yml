name: Haxball.JS Build

on:
  schedule:
    - cron: "0 0 * * 0" # Run at 00:00 on Sunday
  workflow_dispatch: # Allow manual triggers
  push:
    branches: [main, actions]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]
      fail-fast: false # Continue with other tests even if one fails

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run required tests
        run: npm test
        env:
          TEST_PROXY: "" # Don't run proxy tests by default

      - name: Run proxy tests (optional)
        if: always() # Run even if previous step failed
        continue-on-error: true # Continue workflow even if proxy tests fail
        run: npm test
        env:
          TEST_PROXY: "1"

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run nodeify script
        id: nodeify
        run: |
          OUTPUT=$(node scripts/nodeify.js)
          if [[ $OUTPUT =~ SUCCESS:([a-zA-Z0-9]+) ]]; then
            HASH="${BASH_REMATCH[1]}"
            echo "hash=$HASH" >> $GITHUB_OUTPUT
            echo "Build successful with hash: $HASH"
          else
            echo "Build failed: $OUTPUT"
            exit 1
          fi

      - name: Prepare build artifact
        run: |
          mv src/build.js src/index.js
          echo "Renamed build.js to index.js"

      - name: Commit and push if changed
        if: github.event_name != 'pull_request'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          if [[ -n "$(git status --porcelain)" ]]; then
            git add src/index.js
            git commit -m "Update build (${{ steps.nodeify.outputs.hash }})"
            git push
          else
            echo "No changes to commit"
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: haxball-build
          path: src/index.js
          retention-days: 7
